<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程旗艦系統 - 系統中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --bg: #f4f7f9; --border: #dee2e6; }
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; margin: 0; background: var(--bg); }
        .navbar { background: var(--primary); color: white; padding: 0 40px; height: 65px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 20px; }
        .btn-save { background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1rem; width: 100%; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
        input { width: 90%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-add { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-brand">系統中心 / SYSTEM PANEL</div>
    <div class="nav-links"><a href="bom.html" style="color:white; text-decoration:none;">← 返回核心計算</a></div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="card">
            <h3>全域參數設定</h3>
            <label>報價毛利 (倍率)</label>
            <input type="number" id="cfg_markup" value="1.2" step="0.1">
            <p style="font-size: 11px; color: #666; margin-top: 5px;">* 計算公式：成本總計 × 毛利倍率</p>
            <button class="btn-save" onclick="saveAll()">儲存所有設定</button>
        </div>
    </div>

    <div class="main-content">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>設備資料庫連動</h3>
                <button class="btn-add" onclick="addDeviceRow()">+ 新增設備</button>
            </div>
            <table>
                <thead>
                    <tr><th>類別 (FFU/Chiller/Light)</th><th>設備規格名稱</th><th>單價 (未稅)</th><th>操作</th></tr>
                </thead>
                <tbody id="device_table"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let devices = [];

    function init() {
        const savedDevs = localStorage.getItem('eng_sys_devices');
        if (savedDevs) {
            devices = JSON.parse(savedDevs);
        } else {
            devices = [
                {cat: 'FFU', name: '標準型 FFU', price: 12500},
                {cat: 'Chiller', name: '氣冷式主機', price: 45000},
                {cat: 'Light', name: 'LED 平板燈', price: 1800}
            ];
        }
        
        const savedCfg = localStorage.getItem('eng_sys_config');
        if (savedCfg) {
            const cfg = JSON.parse(savedCfg);
            document.getElementById('cfg_markup').value = cfg.markup;
        }
        
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('device_table');
        tbody.innerHTML = "";
        devices.forEach((d, index) => {
            tbody.innerHTML += `
                <tr>
                    <td><input type="text" value="${d.cat}" onchange="updateDev(${index}, 'cat', this.value)"></td>
                    <td><input type="text" value="${d.name}" onchange="updateDev(${index}, 'name', this.value)"></td>
                    <td><input type="number" value="${d.price}" onchange="updateDev(${index}, 'price', this.value)"></td>
                    <td><button onclick="removeDev(${index})" style="color:red; border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
        });
    }

    function addDeviceRow() {
        devices.push({ cat: "FFU", name: "新設備", price: 0 });
        renderTable();
    }

    function updateDev(i, field, val) {
        devices[i][field] = field === 'price' ? parseFloat(val) : val;
    }

    function removeDev(i) {
        devices.splice(i, 1);
        renderTable();
    }

    function saveAll() {
        // 1. 儲存設備資料庫
        localStorage.setItem('eng_sys_devices', JSON.stringify(devices));
        
        // 2. 儲存系統設定
        const config = {
            markup: document.getElementById('cfg_markup').value
        };
        localStorage.setItem('eng_sys_config', JSON.stringify(config));
        
        alert("✅ 連動數據已儲存！核心計算頁面將自動更新。");
    }

    window.onload = init;
</script>
</body>
</html>
