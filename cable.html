<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>電力自動配對系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        .header-box { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #3498db; margin-bottom: 25px; padding-bottom: 10px; }
        h2 { margin: 0; color: #2c3e50; }
        /* 確保按鈕連結正確 */
        .btn-home { color: #2c3e50; text-decoration: none; padding: 6px 15px; border: 1px solid #bdc3c7; border-radius: 4px; font-weight: bold; font-size: 14px; background: #fff; transition: 0.2s; }
        .btn-home:hover { background: #f8f9fa; border-color: #3498db; color: #3498db; }
        .input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        @media (min-width: 768px) { .input-grid { grid-template-columns: repeat(5, 1fr); } }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #34495e; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .button-group { display: flex; gap: 10px; margin-bottom: 25px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-add { background-color: #27ae60; color: white; }
        .btn-add:hover { background-color: #219150; }
        .btn-clear { background-color: #e74c3c; color: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #f8f9fa; color: #2c3e50; }
        .highlight-main { font-weight: bold; color: #2980b9; background-color: #ebf5fb; }
        .info-text { font-size: 12px; color: #7f8c8d; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <a href="index.html" class="btn-home">回首頁</a>
        <h2>電力自動配對系統 </h2>
        <div style="width: 70px;"></div>
    </div>
    
    <div class="input-grid">
        <div class="form-group">
            <label>設備名稱</label>
            <input type="text" id="deviceName" placeholder="設備名稱">
        </div>
        <div class="form-group">
            <label>需求電流 (A)</label>
            <input type="number" id="inputAmp" placeholder="A">
        </div>
        <div class="form-group">
            <label>芯數 (Core)</label>
            <select id="coreCount"></select>
        </div>
        <div class="form-group">
            <label>絕緣型式</label>
            <select id="insulation">
                <option value="XLPE">XLPE (90°C)</option>
                <option value="PVC">PVC (60°C)</option>
            </select>
        </div>
    </div>

    <div class="button-group">
        <button class="btn-add" onclick="addRecord()">新增至列表</button>
        <button onclick="exportToExcel()" style="background:#3498db; color:white;">導出 Excel</button>
        <button class="btn-clear" onclick="clearList()">清空列表</button>
    </div>

    <table id="resultTable">
        <thead>
            <tr>
                <th>設備</th>
                <th>需求電流</th>
                <th>電纜規格</th>
                <th>主線徑 (mm²)</th>
                <th>接地線 G</th>
                <th>電纜外徑 (mm)</th>
                <th>PVC管 (mm/吋)</th>
                <th>EMT管 (mm/吋)</th>
                <th>RSG管 (mm/吋)</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>
    <p class="info-text">* 提示：請確保 index.html 檔案與此程式放在同一個資料夾中，連結才能正常運作。</p>
</div>

<script>
// (內部計算邏輯維持不變，已鎖定主線徑配管)
const coreSelect = document.getElementById('coreCount');
for(let i=1; i<=10; i++) {
    let opt = document.createElement('option');
    opt.value = i; opt.innerHTML = i + 'C';
    if(i===3) opt.selected = true;
    coreSelect.appendChild(opt);
}

function getCoreFactor(cores) {
    if (cores <= 3) return 1.0;
    if (cores <= 6) return 0.8;
    if (cores <= 9) return 0.7;
    return 0.5;
}

const ampTable = {
    'XLPE': [
        {sq: 1.6, base: 24, dia: 3.2}, {sq: 2, base: 28, dia: 3.6}, {sq: 3.5, base: 30, dia: 4.2},
        {sq: 5.5, base: 39, dia: 5.1}, {sq: 8, base: 51, dia: 5.9}, {sq: 14, base: 74, dia: 7.6},
        {sq: 22, base: 93, dia: 9.2}, {sq: 38, base: 130, dia: 11.5}, {sq: 60, base: 176, dia: 14.0},
        {sq: 100, base: 242, dia: 18.0}, {sq: 125, base: 285, dia: 20.0}, {sq: 150, base: 325, dia: 22.0},
        {sq: 200, base: 395, dia: 25.5}, {sq: 250, base: 450, dia: 28.5}, {sq: 325, base: 535, dia: 32.5},
        {sq: 400, base: 615, dia: 36.0}, {sq: 500, base: 710, dia: 40.5}
    ],
    'PVC': [
        {sq: 1.6, base: 13, dia: 3.2}, {sq: 2, base: 18, dia: 3.6}, {sq: 3.5, base: 19, dia: 4.2},
        {sq: 5.5, base: 25, dia: 5.1}, {sq: 8, base: 33, dia: 5.9}, {sq: 14, base: 50, dia: 7.6},
        {sq: 22, base: 60, dia: 9.2}, {sq: 38, base: 85, dia: 11.5}, {sq: 60, base: 115, dia: 14.0},
        {sq: 100, base: 160, dia: 18.0}
    ]
};

const conduitTable = {
    1.6: {pvc: "16 (1/2\")", emt: "15 (1/2\")", rsg: "16 (1/2\")"},
    2:   {pvc: "16 (1/2\")", emt: "19 (3/4\")", rsg: "16 (1/2\")"},
    3.5: {pvc: "16 (1/2\")", emt: "19 (3/4\")", rsg: "16 (1/2\")"},
    5.5: {pvc: "16 (1/2\")", emt: "25 (1\")", rsg: "22 (3/4\")"},
    8:   {pvc: "20 (3/4\")", emt: "25 (1\")", rsg: "22 (3/4\")"},
    14:  {pvc: "28 (1\")", emt: "31 (1-1/4\")", rsg: "28 (1\")"},
    22:  {pvc: "35 (1-1/4\")", emt: "31 (1-1/4\")", rsg: "28 (1\")"},
    38:  {pvc: "41 (1-1/2\")", emt: "39 (1-1/2\")", rsg: "36 (1-1/4\")"},
    60:  {pvc: "52 (2\")", emt: "51 (2\")", rsg: "54 (2\")"},
    100: {pvc: "67 (2-1/2\")", emt: "75 (3\")", rsg: "70 (2-1/2\")"},
    125: {pvc: "80 (3\")", emt: "88 (3-1/2\")", rsg: "82 (3\")"},
    150: {pvc: "80 (3\")", emt: "88 (3-1/2\")", rsg: "82 (3\")"},
    200: {pvc: "90 (3-1/2\")", emt: "100 (4\")", rsg: "104 (4\")"},
    250: {pvc: "100 (4\")", emt: "114 (4-1/2\")", rsg: "114 (4-1/2\")"},
    325: {pvc: "100 (4\")", emt: "114 (4-1/2\")", rsg: "114 (4-1/2\")"},
    400: {pvc: "125 (5\")", emt: "150 (6\")", rsg: "150 (6\")"},
    500: {pvc: "125 (5\")", emt: "150 (6\")", rsg: "150 (6\")"}
};

function getGroundingWire(amp) {
    if (amp <= 30) return "2.0 mm";
    if (amp <= 60) return "5.5 mm²";
    if (amp <= 100) return "8 mm²";
    if (amp <= 200) return "14 mm²";
    if (amp <= 400) return "22 mm²"; 
    if (amp <= 600) return "38 mm²"; 
    return "50 mm²";
}

function addRecord() {
    const name = document.getElementById('deviceName').value || "-";
    const amp = parseFloat(document.getElementById('inputAmp').value);
    const cores = parseInt(document.getElementById('coreCount').value);
    const insu = document.getElementById('insulation').value;

    if (isNaN(amp)) return;

    let selected = null;
    const factor = getCoreFactor(cores);
    for (let item of ampTable[insu]) {
        if ((item.base * factor) >= amp) {
            selected = item;
            break;
        }
    }

    if (!selected) { alert("超出範圍"); return; }

    const estOD = (selected.dia * Math.sqrt(cores) * 1.2).toFixed(1);
    const finalG = getGroundingWire(amp);
    const cond = conduitTable[selected.sq];

    const row = `
        <tr>
            <td>${name}</td>
            <td>${amp}A</td>
            <td>${insu} ${cores}C</td>
            <td class="highlight-main">${selected.sq}</td>
            <td>${finalG}</td>
            <td style="color:#7f8c8d;">${estOD}</td>
            <td>${cond.pvc}</td>
            <td>${cond.emt}</td>
            <td>${cond.rsg}</td>
        </tr>
    `;
    document.getElementById('resultBody').insertAdjacentHTML('beforeend', row);
}

function clearList() { if(confirm("確定清空？")) document.getElementById('resultBody').innerHTML = ""; }
function exportToExcel() {
    const wb = XLSX.utils.table_to_book(document.getElementById("resultTable"));
    XLSX.writeFile(wb, "Power_Calculation_Data.xlsx");
}
</script>
</body>
</html>
